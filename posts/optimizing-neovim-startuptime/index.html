<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Optimizing Neovim Startuptime | NTBBloodbath</title>
<meta name=keywords content="neovim,lua">
<meta name=description content="This is a complete guide on how to optimize your Neovim configuration startuptime the hardcore way">
<meta name=author content="NTBBloodbath">
<link rel=canonical href=https://ntbbloodbath.github.io/posts/optimizing-neovim-startuptime/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.4fbb168550970e089b8e0f3904476b0ead1c918bc8a6183a3b16c32eb2d534e0.css integrity="sha256-T7sWhVCXDgibjg85BEdrDq0ckYvIphg6OxbDLrLVNOA=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href="https://avatars.githubusercontent.com/u/36456999?v=4">
<link rel=icon type=image/png sizes=16x16 href=https://ntbbloodbath.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://ntbbloodbath.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://ntbbloodbath.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://ntbbloodbath.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Optimizing Neovim Startuptime">
<meta property="og:description" content="This is a complete guide on how to optimize your Neovim configuration startuptime the hardcore way">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ntbbloodbath.github.io/posts/optimizing-neovim-startuptime/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-22T18:06:44-04:00">
<meta property="article:modified_time" content="2021-12-22T18:06:44-04:00"><meta property="og:site_name" content="NTBBloodbath">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Optimizing Neovim Startuptime">
<meta name=twitter:description content="This is a complete guide on how to optimize your Neovim configuration startuptime the hardcore way">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ntbbloodbath.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Optimizing Neovim Startuptime","item":"https://ntbbloodbath.github.io/posts/optimizing-neovim-startuptime/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Optimizing Neovim Startuptime","name":"Optimizing Neovim Startuptime","description":"This is a complete guide on how to optimize your Neovim configuration startuptime the hardcore way","keywords":["neovim","lua"],"articleBody":"As you may know, if you bloat your Neovim configuration with a good amount of plugins it’s going to get slower and slower and this can be a VERY BIG problem because you will need to wait a lot of time to start editing. This guide aims to help you resolve this slow startuptime issue.\nSpecial thanks to vhyrro, who taught me several tricks mentioned in this post ❤️.\n Important: Before starting, this guide is intended for Neovim = 0.5 users and it’s fully oriented to Lua. If you’re using Vimscript I highly recommend you to leave that ugly monster alone and join the Lua side.\n Lazy-loading plugins We will start from here, but first of all, what does lazy-loading means?\nLazy-loading can be read as “load on-demand”. That means you load stuff once you need them. For example, you will surely want to load autocompletion plugins once you start editing or enable a Rust plugin only when editing Rust files.\nFor this specific task I recommend using packer.nvim. This is an advanced plugins manager that allows you to lazy-load your plugins in an easy and declarative way.\nInstalling packer.nvim For installing packer.nvim we will also lazy-load it because why not?\nHaving said that, let’s install it!\n Important: if you’re already using packer.nvim and lazy-loading it you can safely skip this step.\n The first thing that you will need to do is create a new file into your Neovim lua directory (~/.config/nvim/lua on *nix systems). Call it as you want, I’ll call it as plugins.lua.\nOnce you’ve done that, we can begin with packer.nvim installation. We aren’t going to install it using the README way because we’re going to lazy-load it and do some extra small steps to customize bootstrapping.\n Note: bootstrapping means “load a set of instructions when X is launched or turned on”.\n Let’s start with our packer.nvim bootstrapping so packer.nvim will be automatically downloaded if not found in your system.\n-- /home/user/.local/share/nvim/site/pack/packer/opt/packer.nvim local packer_path = vim.fn.stdpath(\"data\") .. \"/site/pack/packer/opt/packer.nvim\" if vim.fn.empty(vim.fn.glob(packer_path))  0 then vim.notify(\"Bootstrapping packer.nvim, please wait ...\") vim.fn.system({ \"git\", \"clone\", \"https://github.com/wbthomason/packer.nvim\", packer_path, }) end vim.cmd(\"packadd packer.nvim\") local packer = require(\"packer\") packer.startup(function(use) -- Plugins manager use({ \"wbthomason/packer.nvim\", opt = true, }) end) And now, what does this code means? Let me explain it to you!\n In the first two lines we’re defining what our packer.nvim installation path is. After those lines we have a conditional that checks if packer.nvim is installed or not and installs it if not installed. Then we manually load packer.nvim plugin after checking its existence in our system and require it. Finally we start packer.nvim with the packer.startup function where we declare our plugins and lazy-load packer.nvim itself.  Now just require that module in your init.lua and relaunch Neovim and packer.nvim will be automatically installed and loaded.\nHow to lazy-load your plugins the proper way Once you have packer.nvim installed and working we can continue with the next step, that is lazy-load your plugins!\n Important: you should never lazy-load nvim-lspconfig if you don’t want to have issues with EFM or diagnosticls language servers and also have faster lsp startup.\n For example, we will lazy-load three big libraries that are used in some plugins and takes a ton of time.\nNote that we’re omitting the initial packer.nvim setup that we did before when installing packer.nvim.\nuse({ \"kyazdani42/nvim-web-devicons\", module = \"nvim-web-devicons\", }) use({ \"nvim-lua/plenary.nvim\", module = \"plenary\", }) use({ \"nvim-lua/popup.nvim\", module = \"popup\", }) Here we tell packer.nvim to load these plugins when we require their Lua modules with a require function (e.g. local plenary = require(\"plenary\")) so they will be loaded only when another plugin requires them.\nWe can also lazy-load plugins in a TON of different ways too. For example, we can load plugins when we trigger certain commands, events, keybinds, etc. The following code chunk are some examples.\n-- Neogit, -- load only once we use `:Neogit` command use({ \"TimUntersberger/neogit\", config = function() require(\"neogit\").setup({}) end, cmd = \"Neogit\", }) -- Tabline, -- load when triggering BufWinEnter event use({ \"akinsho/bufferline.nvim\", config = function() -- Config goes here ... end, event = \"BufWinEnter\", }) -- Autocomplete HTML tags, -- load after loading treesitter plugin use({ \"windwp/nvim-ts-autotag\", after = \"nvim-treesitter\", })  You can find more information about the different ways to lazy-load plugins in Specifying plugins section of packer’s readme.\n Manually lazy-load plugins with packer.nvim We can also make use of :PackerLoad command to manually load plugins with packer.nvim. That command makes use of built-in Neovim :packadd and :source commands under the hood.\nFor example, if we want to lazy-load nvim-treesitter plugin manually we could do the following.\n----- In our plugins.lua ------- use({ \"nvim-treesitter/nvim-treesitter\", opt = true, run = \":TSUpdate\", config = function() -- Config goes here ... end, }) ----- In our init.lua ---------- -- This conditional ensures packer and treesitter plugin are -- installed before trying to load treesitter plugin if packer_plugins and packer_plugins[\"nvim-treesitter\"] then vim.cmd(\"PackerLoad nvim-treesitter\") end You can read further about how PackerLoad works internally here.\nAltering Neovim defaults There are other ways to also improve Neovim startuptime and altering some Neovim defaults is one of those ways. For example, you could temporarily disable syntax highlighting and ftplugin on launch to reduce your startuptime in around 20ms or even more and defer some things.\nTemporarily disabling syntax highlighting and filetype -- This needs to be at top of your `init.lua` vim.cmd([[ syntax off filetype off filetype plugin indent off ]]) After this, we will want to re-enable those options at the end of our init.lua. We will use the same code snippet but using on instead of off.\n-- This needs to be at bottom of your `init.lua` vim.cmd([[ syntax on filetype on filetype plugin indent on ]]) Defer code chunks When we defer chunks of code we are actually using a one-shot timer that calls a function that executes some code. That means, defer calling X function until Y milliseconds passes.\nHow can we defer our code? Neovim Lua API comes with several functions to schedule functions execution, like schedule. However, there is a specific one that we’re going to use that is called defer_fn.\nFrom :h vim.defer_fn():\nvim.defer_fn({fn}, {timeout}) *vim.defer_fn* Defers calling {fn} until {timeout} ms passes. Use to do a one-shot timer that calls {fn}. Note: The {fn} is |schedule_wrap|ped automatically, so API functions are safe to call. Parameters: ~ {fn} Callback to call once {timeout} expires {timeout} Time in ms to wait before calling {fn} Returns: ~ |vim.loop|.new_timer() objectAs we can see, vim.defer_fn gets two non-optional parameters. A function and a timeout (in milliseconds).\nSaid that, we could do something like this in our init.lua.\n-- The code inside that function will be called -- after everything else in your `init.lua` vim.defer_fn(function() -- Require our plugins declaration module require(\"plugins\") -- Re-enable syntax highlighting and filetype plugin -- once Neovim is fully loaded. vim.cmd([[ syntax on filetype on filetype plugin indent on ]]) -- This conditional ensures packer and treesitter plugin are -- installed before trying to load treesitter plugin if packer_plugins and packer_plugins[\"nvim-treesitter\"] then vim.cmd(\"PackerLoad nvim-treesitter\") end end, 0)  Note: This also brings us a “security” improvement because vim.defer_fn function also waits for the Neovim API to be safe to call as the Neovim docs says.\n Is it a good idea to defer everything? As a short answer, no. It’s not a good idea to defer everything.\nAs I told before it just a timer that delays code execution and can cause issues if we load some stuff in the wrong order.\n","wordCount":"1246","inLanguage":"en","datePublished":"2021-12-22T18:06:44-04:00","dateModified":"2021-12-22T18:06:44-04:00","author":{"@type":"Person","name":"NTBBloodbath"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ntbbloodbath.github.io/posts/optimizing-neovim-startuptime/"},"publisher":{"@type":"Organization","name":"NTBBloodbath","logo":{"@type":"ImageObject","url":"https://avatars.githubusercontent.com/u/36456999?v=4"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://ntbbloodbath.github.io/ accesskey=h title="NTBBloodbath (Alt + H)">NTBBloodbath</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://ntbbloodbath.github.io/categories/ title=categories>
<span>categories</span>
</a>
</li>
<li>
<a href=https://ntbbloodbath.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://ntbbloodbath.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ntbbloodbath.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Optimizing Neovim Startuptime<sup><span class=entry-isdraft>&nbsp;&nbsp;[draft]</span></sup>
</h1>
<div class=post-description>
This is a complete guide on how to optimize your Neovim configuration startuptime the hardcore way
</div>
<div class=post-meta><span title="2021-12-22 18:06:44 -0400 -0400">December 22, 2021</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;NTBBloodbath&nbsp;|&nbsp;<a href=https://github.com/NTBBloodbath/ntbbloodbath.github.io/content/posts/optimizing-neovim-startuptime.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#lazy-loading-plugins aria-label="Lazy-loading plugins">Lazy-loading plugins</a><ul>
<li>
<a href=#installing-packernvim aria-label="Installing packer.nvim">Installing packer.nvim</a></li>
<li>
<a href=#how-to-lazy-load-your-plugins-the-proper-way aria-label="How to lazy-load your plugins the proper way">How to lazy-load your plugins the proper way</a><ul>
<li>
<a href=#manually-lazy-load-plugins-with-packernvim aria-label="Manually lazy-load plugins with packer.nvim">Manually lazy-load plugins with packer.nvim</a></li></ul>
</li></ul>
</li>
<li>
<a href=#altering-neovim-defaults aria-label="Altering Neovim defaults">Altering Neovim defaults</a><ul>
<li>
<a href=#temporarily-disabling-syntax-highlighting-and-filetype aria-label="Temporarily disabling syntax highlighting and filetype">Temporarily disabling syntax highlighting and filetype</a></li>
<li>
<a href=#defer-code-chunks aria-label="Defer code chunks">Defer code chunks</a><ul>
<li>
<a href=#how-can-we-defer-our-code aria-label="How can we defer our code?">How can we defer our code?</a></li>
<li>
<a href=#is-it-a-good-idea-to-defer-everything aria-label="Is it a good idea to defer everything?">Is it a good idea to defer everything?</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>As you may know, if you bloat your Neovim configuration with a good amount of plugins it&rsquo;s going to get
slower and slower and this can be a VERY BIG problem because you will need to wait a lot of time to start
editing. This guide aims to help you resolve this slow startuptime issue.</p>
<p>Special thanks to <a href=https://github.com/vhyrro>vhyrro</a>, who taught me several tricks mentioned in this post ❤️.</p>
<blockquote>
<p><strong>Important</strong>: Before starting, this guide is intended for Neovim >= 0.5 users and it&rsquo;s fully oriented to Lua.
If you&rsquo;re using Vimscript I highly recommend you to leave that ugly monster alone and join the Lua side.</p>
</blockquote>
<h2 id=lazy-loading-plugins>Lazy-loading plugins<a hidden class=anchor aria-hidden=true href=#lazy-loading-plugins>#</a></h2>
<p>We will start from here, but first of all, what does lazy-loading means?</p>
<p>Lazy-loading can be read as &ldquo;load on-demand&rdquo;. That means you load stuff once you need them. For example,
you will surely want to load autocompletion plugins once you start editing or enable a Rust plugin only when
editing Rust files.</p>
<p>For this specific task I recommend using <a href=https://github.com/wbthomason/packer.nvim>packer.nvim</a>. This is an
advanced plugins manager that allows you to lazy-load your plugins in an easy and declarative way.</p>
<h3 id=installing-packernvim>Installing packer.nvim<a hidden class=anchor aria-hidden=true href=#installing-packernvim>#</a></h3>
<p>For installing <code>packer.nvim</code> we will also lazy-load it because why not?</p>
<p>Having said that, let&rsquo;s install it!</p>
<blockquote>
<p><strong>Important</strong>: if you&rsquo;re already using <code>packer.nvim</code> and lazy-loading it you can safely skip this step.</p>
</blockquote>
<p>The first thing that you will need to do is create a new file into your Neovim lua directory (<code>~/.config/nvim/lua</code>
on *nix systems). Call it as you want, I&rsquo;ll call it as <code>plugins.lua</code>.</p>
<p>Once you&rsquo;ve done that, we can begin with <code>packer.nvim</code> installation. We aren&rsquo;t going to install it using the README
way because we&rsquo;re going to lazy-load it and do some extra small steps to customize bootstrapping.</p>
<blockquote>
<p><strong>Note</strong>: bootstrapping means &ldquo;load a set of instructions when X is launched or turned on&rdquo;.</p>
</blockquote>
<p>Let&rsquo;s start with our <code>packer.nvim</code> bootstrapping so <code>packer.nvim</code> will be automatically downloaded if not found in your system.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- /home/user/.local/share/nvim/site/pack/packer/opt/packer.nvim</span>
<span class=kd>local</span> <span class=n>packer_path</span> <span class=o>=</span>
  <span class=n>vim.fn</span><span class=p>.</span><span class=n>stdpath</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>)</span> <span class=o>..</span> <span class=s2>&#34;/site/pack/packer/opt/packer.nvim&#34;</span>

<span class=kr>if</span> <span class=n>vim.fn</span><span class=p>.</span><span class=n>empty</span><span class=p>(</span><span class=n>vim.fn</span><span class=p>.</span><span class=n>glob</span><span class=p>(</span><span class=n>packer_path</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=kr>then</span>
  <span class=n>vim.notify</span><span class=p>(</span><span class=s2>&#34;Bootstrapping packer.nvim, please wait ...&#34;</span><span class=p>)</span>
  <span class=n>vim.fn</span><span class=p>.</span><span class=n>system</span><span class=p>({</span>
    <span class=s2>&#34;git&#34;</span><span class=p>,</span>
    <span class=s2>&#34;clone&#34;</span><span class=p>,</span>
    <span class=s2>&#34;https://github.com/wbthomason/packer.nvim&#34;</span><span class=p>,</span>
    <span class=n>packer_path</span><span class=p>,</span>
  <span class=p>})</span>
<span class=kr>end</span>

<span class=n>vim.cmd</span><span class=p>(</span><span class=s2>&#34;packadd packer.nvim&#34;</span><span class=p>)</span>
<span class=kd>local</span> <span class=n>packer</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;packer&#34;</span><span class=p>)</span>

<span class=n>packer.startup</span><span class=p>(</span><span class=kr>function</span><span class=p>(</span><span class=n>use</span><span class=p>)</span>
  <span class=c1>-- Plugins manager</span>
  <span class=n>use</span><span class=p>({</span>
    <span class=s2>&#34;wbthomason/packer.nvim&#34;</span><span class=p>,</span>
    <span class=n>opt</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
  <span class=p>})</span>
<span class=kr>end</span><span class=p>)</span>
</code></pre></div><p>And now, what does this code means? Let me explain it to you!</p>
<ul>
<li>In the first two lines we&rsquo;re defining what our <code>packer.nvim</code> installation path is.</li>
<li>After those lines we have a conditional that checks if <code>packer.nvim</code> is installed or not and installs it if not installed.</li>
<li>Then we manually load <code>packer.nvim</code> plugin after checking its existence in our system and require it.</li>
<li>Finally we start <code>packer.nvim</code> with the <code>packer.startup</code> function where we declare our plugins and lazy-load <code>packer.nvim</code> itself.</li>
</ul>
<p>Now just require that module in your <code>init.lua</code> and relaunch Neovim and <code>packer.nvim</code> will be automatically installed and loaded.</p>
<h3 id=how-to-lazy-load-your-plugins-the-proper-way>How to lazy-load your plugins the proper way<a hidden class=anchor aria-hidden=true href=#how-to-lazy-load-your-plugins-the-proper-way>#</a></h3>
<p>Once you have <code>packer.nvim</code> installed and working we can continue with the next step, that is lazy-load your
plugins!</p>
<blockquote>
<p><strong>Important</strong>: you should never lazy-load <code>nvim-lspconfig</code> if you don&rsquo;t want to have issues with EFM or diagnosticls language servers
and also have faster lsp startup.</p>
</blockquote>
<p>For example, we will lazy-load three big libraries that are used in some plugins and takes a ton of time.</p>
<p><em>Note that we&rsquo;re omitting the initial <code>packer.nvim</code> setup that we did before when installing <code>packer.nvim</code></em>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;kyazdani42/nvim-web-devicons&#34;</span><span class=p>,</span>
  <span class=n>module</span> <span class=o>=</span> <span class=s2>&#34;nvim-web-devicons&#34;</span><span class=p>,</span>
<span class=p>})</span>

<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;nvim-lua/plenary.nvim&#34;</span><span class=p>,</span>
  <span class=n>module</span> <span class=o>=</span> <span class=s2>&#34;plenary&#34;</span><span class=p>,</span>
<span class=p>})</span>

<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;nvim-lua/popup.nvim&#34;</span><span class=p>,</span>
  <span class=n>module</span> <span class=o>=</span> <span class=s2>&#34;popup&#34;</span><span class=p>,</span>
<span class=p>})</span>
</code></pre></div><p>Here we tell <code>packer.nvim</code> to load these plugins when we require their Lua modules with a <code>require</code> function
(e.g. <code>local plenary = require("plenary")</code>) so they will be loaded only when another plugin requires them.</p>
<p>We can also lazy-load plugins in a TON of different ways too. For example, we can load plugins when we trigger certain commands, events, keybinds, etc.
The following code chunk are some examples.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- Neogit,</span>
<span class=c1>-- load only once we use `:Neogit` command</span>
<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;TimUntersberger/neogit&#34;</span><span class=p>,</span>
  <span class=n>config</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
    <span class=n>require</span><span class=p>(</span><span class=s2>&#34;neogit&#34;</span><span class=p>).</span><span class=n>setup</span><span class=p>({})</span>
  <span class=kr>end</span><span class=p>,</span>
  <span class=n>cmd</span> <span class=o>=</span> <span class=s2>&#34;Neogit&#34;</span><span class=p>,</span>
<span class=p>})</span>


<span class=c1>-- Tabline,</span>
<span class=c1>-- load when triggering BufWinEnter event</span>
<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;akinsho/bufferline.nvim&#34;</span><span class=p>,</span>
  <span class=n>config</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
    <span class=c1>-- Config goes here ...</span>
  <span class=kr>end</span><span class=p>,</span>
  <span class=n>event</span> <span class=o>=</span> <span class=s2>&#34;BufWinEnter&#34;</span><span class=p>,</span>
<span class=p>})</span>

<span class=c1>-- Autocomplete HTML tags,</span>
<span class=c1>-- load after loading treesitter plugin</span>
<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;windwp/nvim-ts-autotag&#34;</span><span class=p>,</span>
  <span class=n>after</span> <span class=o>=</span> <span class=s2>&#34;nvim-treesitter&#34;</span><span class=p>,</span>
<span class=p>})</span>
</code></pre></div><blockquote>
<p>You can find more information about the different ways to lazy-load plugins
in <a href=https://github.com/wbthomason/packer.nvim#specifying-plugins>Specifying plugins</a> section of packer&rsquo;s readme.</p>
</blockquote>
<h4 id=manually-lazy-load-plugins-with-packernvim>Manually lazy-load plugins with packer.nvim<a hidden class=anchor aria-hidden=true href=#manually-lazy-load-plugins-with-packernvim>#</a></h4>
<p>We can also make use of <code>:PackerLoad</code> command to manually load plugins with <code>packer.nvim</code>. That command makes use of
built-in Neovim <code>:packadd</code> and <code>:source</code> commands under the hood.</p>
<p>For example, if we want to lazy-load <code>nvim-treesitter</code> plugin manually we could do the following.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>----- In our plugins.lua -------</span>
<span class=n>use</span><span class=p>({</span>
  <span class=s2>&#34;nvim-treesitter/nvim-treesitter&#34;</span><span class=p>,</span>
  <span class=n>opt</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
  <span class=n>run</span> <span class=o>=</span> <span class=s2>&#34;:TSUpdate&#34;</span><span class=p>,</span>
  <span class=n>config</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span>
    <span class=c1>-- Config goes here ...</span>
  <span class=kr>end</span><span class=p>,</span>
<span class=p>})</span>

<span class=c1>----- In our init.lua ----------</span>
<span class=c1>-- This conditional ensures packer and treesitter plugin are</span>
<span class=c1>-- installed before trying to load treesitter plugin</span>
<span class=kr>if</span> <span class=n>packer_plugins</span> <span class=ow>and</span> <span class=n>packer_plugins</span><span class=p>[</span><span class=s2>&#34;nvim-treesitter&#34;</span><span class=p>]</span> <span class=kr>then</span>
  <span class=n>vim.cmd</span><span class=p>(</span><span class=s2>&#34;PackerLoad nvim-treesitter&#34;</span><span class=p>)</span>
<span class=kr>end</span>
</code></pre></div><p>You can read further about how <code>PackerLoad</code> works internally <a href=https://github.com/wbthomason/packer.nvim/blob/master/lua/packer/load.lua#L118-L159>here</a>.</p>
<h2 id=altering-neovim-defaults>Altering Neovim defaults<a hidden class=anchor aria-hidden=true href=#altering-neovim-defaults>#</a></h2>
<p>There are other ways to also improve Neovim startuptime and altering some Neovim defaults is one of those ways.
For example, you could temporarily disable syntax highlighting and ftplugin on launch to reduce your startuptime in around 20ms <em>or even more</em>
and defer some things.</p>
<h3 id=temporarily-disabling-syntax-highlighting-and-filetype>Temporarily disabling syntax highlighting and filetype<a hidden class=anchor aria-hidden=true href=#temporarily-disabling-syntax-highlighting-and-filetype>#</a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- This needs to be at top of your `init.lua`</span>
<span class=n>vim.cmd</span><span class=p>(</span><span class=s>[[
</span><span class=s>  syntax off
</span><span class=s>  filetype off
</span><span class=s>  filetype plugin indent off
</span><span class=s>]]</span><span class=p>)</span>
</code></pre></div><p>After this, we will want to re-enable those options at the end of our <code>init.lua</code>.
We will use the same code snippet but using <code>on</code> instead of <code>off</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- This needs to be at bottom of your `init.lua`</span>
<span class=n>vim.cmd</span><span class=p>(</span><span class=s>[[
</span><span class=s>  syntax on
</span><span class=s>  filetype on
</span><span class=s>  filetype plugin indent on
</span><span class=s>]]</span><span class=p>)</span>
</code></pre></div><h3 id=defer-code-chunks>Defer code chunks<a hidden class=anchor aria-hidden=true href=#defer-code-chunks>#</a></h3>
<p>When we defer chunks of code we are actually using a one-shot timer that calls a function
that executes some code. That means, defer calling X function until Y milliseconds passes.</p>
<h4 id=how-can-we-defer-our-code>How can we defer our code?<a hidden class=anchor aria-hidden=true href=#how-can-we-defer-our-code>#</a></h4>
<p>Neovim Lua API comes with several functions to schedule functions execution, like <code>schedule</code>.
However, there is a specific one that we&rsquo;re going to use that is called <code>defer_fn</code>.</p>
<p><em>From <code>:h vim.defer_fn()</code></em>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-vim data-lang=vim><span class=nx>vim</span>.<span class=nx>defer_fn</span><span class=p>(</span>{<span class=nx>fn</span>}<span class=p>,</span> {<span class=nx>timeout</span>}<span class=p>)</span>                                    *<span class=nx>vim</span>.<span class=nx>defer_fn</span>*<span class=err>
</span><span class=err></span>    <span class=nx>Defers</span> <span class=nx>calling</span> {<span class=nx>fn</span>} <span class=nx>until</span> {<span class=nx>timeout</span>} <span class=nx>ms</span> <span class=nx>passes</span>.  <span class=nx>Use</span> <span class=nx>to</span> <span class=nx>do</span> <span class=nx>a</span> <span class=nx>one</span><span class=p>-</span><span class=nx>shot</span> <span class=nx>timer</span><span class=err>
</span><span class=err></span>    <span class=nx>that</span> <span class=nx>calls</span> {<span class=nx>fn</span>}.<span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=nx>Note</span>: <span class=nx>The</span> {<span class=nx>fn</span>} <span class=nx>is</span> <span class=p>|</span><span class=nx>schedule_wrap</span><span class=p>|</span><span class=nx>ped</span> <span class=nx>automatically</span><span class=p>,</span> <span class=nx>so</span> <span class=nx>API</span> <span class=nx>functions</span> <span class=nx>are</span><span class=err>
</span><span class=err></span>    <span class=nx>safe</span> <span class=nx>to</span> <span class=nx>call</span>.<span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=nx>Parameters</span>: <span class=p>~</span><span class=err>
</span><span class=err></span>        {<span class=nx>fn</span>}        <span class=nx>Callback</span> <span class=nx>to</span> <span class=nx>call</span> <span class=nx>once</span> {<span class=nx>timeout</span>} <span class=nx>expires</span><span class=err>
</span><span class=err></span>        {<span class=nx>timeout</span>}   <span class=nx>Time</span> <span class=nx>in</span> <span class=nx>ms</span> <span class=nx>to</span> <span class=nx>wait</span> <span class=nx>before</span> <span class=nx>calling</span> {<span class=nx>fn</span>}<span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=nx>Returns</span>: <span class=p>~</span><span class=err>
</span><span class=err></span>        <span class=p>|</span><span class=nx>vim</span>.<span class=nx>loop</span><span class=p>|</span>.<span class=nx>new_timer</span><span class=p>()</span> <span class=nx>object</span><span class=err>
</span><span class=err>
</span></code></pre></div><p>As we can see, <code>vim.defer_fn</code> gets two non-optional parameters. A function and a timeout (in milliseconds).</p>
<p>Said that, we could do something like this in our <code>init.lua</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- The code inside that function will be called</span>
<span class=c1>-- after everything else in your `init.lua`</span>
<span class=n>vim.defer_fn</span><span class=p>(</span><span class=kr>function</span><span class=p>()</span>
  <span class=c1>-- Require our plugins declaration module</span>
  <span class=n>require</span><span class=p>(</span><span class=s2>&#34;plugins&#34;</span><span class=p>)</span>

  <span class=c1>-- Re-enable syntax highlighting and filetype plugin</span>
  <span class=c1>-- once Neovim is fully loaded.</span>
  <span class=n>vim.cmd</span><span class=p>(</span><span class=s>[[
</span><span class=s>    syntax on
</span><span class=s>    filetype on
</span><span class=s>    filetype plugin indent on
</span><span class=s>  ]]</span><span class=p>)</span>

  <span class=c1>-- This conditional ensures packer and treesitter plugin are</span>
  <span class=c1>-- installed before trying to load treesitter plugin</span>
  <span class=kr>if</span> <span class=n>packer_plugins</span> <span class=ow>and</span> <span class=n>packer_plugins</span><span class=p>[</span><span class=s2>&#34;nvim-treesitter&#34;</span><span class=p>]</span> <span class=kr>then</span>
    <span class=n>vim.cmd</span><span class=p>(</span><span class=s2>&#34;PackerLoad nvim-treesitter&#34;</span><span class=p>)</span>
  <span class=kr>end</span>
<span class=kr>end</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</code></pre></div><blockquote>
<p><strong>Note</strong>: This also brings us a &ldquo;security&rdquo; improvement because <code>vim.defer_fn</code> function also waits for
the Neovim API to be safe to call as the Neovim docs says.</p>
</blockquote>
<h4 id=is-it-a-good-idea-to-defer-everything>Is it a good idea to defer everything?<a hidden class=anchor aria-hidden=true href=#is-it-a-good-idea-to-defer-everything>#</a></h4>
<p>As a short answer, no. It&rsquo;s not a good idea to defer everything.</p>
<p>As I told before it just a timer that delays code execution and can cause issues
if we load some stuff in the wrong order.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://ntbbloodbath.github.io/tags/neovim/>neovim</a></li>
<li><a href=https://ntbbloodbath.github.io/tags/lua/>lua</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://ntbbloodbath.github.io/>NTBBloodbath</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>